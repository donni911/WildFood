import x from"node:path";import{lstatSync as _,readdirSync as ee,unlinkSync as J}from"node:fs";import{readFile as te,writeFile as re}from"node:fs/promises";import{performance as D}from"node:perf_hooks";import o from"chalk";import{normalizePath as O,createFilter as se}from"vite";import ae from"imagemin";import ie from"is-apng";import{existsSync as X,mkdirSync as Z}from"node:fs";var z=e=>typeof e=="function",T=e=>typeof e=="boolean",$=e=>typeof e=="string",R=e=>typeof e=="object"&&e!==null&&!Array.isArray(e);var q=e=>Object.prototype.toString.call(e)==="[object RegExp]",C=e=>$(e)||q(e)||Array.isArray(e)&&e.filter(p=>!$(p)&&!q(p)).length==0,F=e=>e.replace(/[[\]{}()*+?.,/\\^$|#-]/g,"\\$&");function H(e,p=493){let t=/\/[^/]*$/;return Array.from(new Set(e.map(r=>r.replace(t,"")))).map(r=>[r,r.split("/").length]).sort((r,i)=>i[1]-r[1]).reduce((r,[i])=>(r.some(c=>c.startsWith(i))||r.push(i),r),[]).map(r=>(X(r)||Z(r,{recursive:!0,mode:p}),r))}var N=e=>{let p=!1;if(e&&R(e)){let t=!1;p=Object.entries(e).reduce((r,[i,c])=>(typeof c=="function"?(r[i]=[c],t=!0):Array.isArray(c)&&(r[i]=c.filter(n=>z(n)),t=t||r[i].length>0),r),{}),t||(p=!1)}return p},ne=e=>{if(!R(e))return!1;let p=N(e.plugins);if(!p)return!1;let t=!1;if(e?.makeAvif&&R(e.makeAvif?.plugins)){let i=N(e.makeAvif.plugins);i&&(t={plugins:i,formatFilePath:z(e.makeAvif.formatFilePath)?e.makeAvif.formatFilePath:c=>`${c}.avif`,skipIfLargerThan:e.makeAvif.skipIfLargerThan===!1||$(e.makeAvif.skipIfLargerThan)?e.makeAvif.skipIfLargerThan:"optimized"})}let r=!1;if(e?.makeWebp&&R(e.makeWebp?.plugins)){let i=N(e.makeWebp.plugins);i&&(r={plugins:i,formatFilePath:z(e.makeWebp.formatFilePath)?e.makeWebp.formatFilePath:c=>`${c}.webp`,skipIfLargerThan:e.makeWebp.skipIfLargerThan===!1||$(e.makeWebp.skipIfLargerThan)?e.makeWebp.skipIfLargerThan:"optimized"})}return{root:$(e?.root)?e.root:void 0,include:C(e?.include)?e.include:[/\.(png|jpg|jpeg|gif|svg)$/i],exclude:C(e?.exclude)?e.exclude:[/node_modules/],onlyAssets:T(e?.onlyAssets)?e.onlyAssets:!1,formatFilePath:z(e?.formatFilePath)?e.formatFilePath:i=>i,skipIfLarger:T(e?.skipIfLarger)?e.skipIfLarger:!0,plugins:p,makeAvif:t,makeWebp:r,verbose:T(e?.verbose)?e.verbose:!0,logger:R(e?.logger)&&z(e?.logger?.info)?e.logger:!1,logByteDivider:e?.logByteDivider&&Number.isInteger(e?.logByteDivider)?e.logByteDivider:1e3}};function Q(e,p){let t=[];try{_(e).isDirectory()?ee(e).forEach(i=>{t=t.concat(Q(x.join(e,x.sep,i),p))}):t.push(e)}catch(r){p.error("Error: "+r?.message)}return t}async function oe({filePathFrom:e,fileToStack:p=[],baseDir:t="",precisions:r,bytesDivider:i,sizeUnit:c}){if(!e?.length)return Promise.reject({oldPath:e,newPath:"",error:"Empty filepath",errorType:"error"});if(!p?.length)return Promise.reject({oldPath:e,newPath:"",error:"Empty to-stack",errorType:"error"});let n,h=0;return te(t+e).then(s=>{let S=D.now();if(n=s,h=n.byteLength,e.endsWith(".png")&&ie(s))throw new Error("SKIP: Animated PNGs not supported");return Promise.allSettled(p.map(k=>{let P,l=0,w=k.toPath;return ae.buffer(n,{plugins:k.plugins}).catch(g=>Promise.reject(g.message?`Error processing file [${g.message}]`:g)).then(g=>{if(P=g,l=P.byteLength,k.skipIfLarger!==!1&&l>h)throw new Error("SKIP: Output is larger");return re(t+w,P)}).catch(g=>(g?.message&&(g.message.startsWith("SKIP: ")?g=g.message:g=`Error writing file [${g.message}]`),Promise.reject(g))).then(()=>{let g=D.now()-S,y=l/h-1;return Promise.resolve({oldPath:e,newPath:w,oldSize:h,newSize:l,ratio:y,duration:g,oldSizeString:`${(h/i).toFixed(r.size)} ${c}`,newSizeString:`${(l/i).toFixed(r.size)} ${c}`,ratioString:`${y>0?"+":y===0?" ":""}${(y*100).toFixed(r.ratio)} %`,durationString:`${g.toFixed(r.duration)} ms`})}).catch(g=>{let y="error";return g.startsWith("SKIP: ")?(g=g.slice(6),y="skip"):g.startsWith("WARN: ")&&(g=g.slice(6),y="warning"),Promise.reject({oldPath:e,newPath:w,error:g,errorType:y})})}))}).catch(s=>{let S="error";return s.message.startsWith("SKIP: ")?(s=s.message.slice(6),S="skip"):s=`Error reading file [${s.message}]`,Promise.reject({oldPath:e,newPath:"",error:s,errorType:S})})}function le(e){let p={from:0,to:0},t={oldPath:0,newPath:0,oldSize:0,newSize:0,ratio:0,duration:0},r={},i={};return e.forEach(c=>{let n;c.status==="fulfilled"?c.value.forEach(h=>{h.status==="fulfilled"?(n=h.value,r[n.oldPath]||(r[n.oldPath]=[]),r[n.oldPath].push({...n}),p.from+=n.oldSize,p.to+=n.newSize,t.oldSize=Math.max(t.oldSize,n.oldSizeString.length),t.newSize=Math.max(t.newSize,n.newSizeString.length),t.ratio=Math.max(t.ratio,n.ratioString.length),t.duration=Math.max(t.duration,n.durationString.length)):(n=h.reason,i[n.oldPath]||(i[n.oldPath]=[]),i[n.oldPath].push({...n})),t.oldPath=Math.max(t.oldPath,n.oldPath.length),t.newPath=Math.max(t.newPath,n.newPath.length)}):(n=c.reason,i[n.oldPath]||(i[n.oldPath]=[]),i[n.oldPath].push({...n}),t.oldPath=Math.max(t.oldPath,n.oldPath.length))}),{totalSize:p,maxLengths:t,processedFiles:r,erroredFiles:i}}function ge(e,p,t){let r=[" \u2514\u2500 "," \u251C\u2500 "],i=r[0].length,c=2,n=Math.max(t.oldPath,t.newPath+i),h=Math.max(t.oldSize,t.newSize);e.forEach((s,S,k)=>{let P=x.basename(s.oldPath),l=x.basename(s.newPath),w=["  "];S===0&&(w.push(o.dim(s.oldPath.replace(new RegExp(`${F(P)}$`),"")),P," ".repeat(n-s.oldPath.length+c)," ".repeat(h-s.oldSizeString.length),s.oldSizeString,o.dim(" \u2502 ")),p.info(w.join("")),w=["  "]),w.push(o.dim(k.length===S+1?r[0]:r[1]),o.dim(s.newPath.replace(new RegExp(`${F(l)}$`),""))),s.webpDeleted=l.endsWith(".webp")&&s.webpDeleted,s.avifDeleted=l.endsWith(".avif")&&s.avifDeleted,s.webpDeleted||s.avifDeleted?w.push(o.dim(l)," ".repeat(n-i-s.newPath.length+c)," ".repeat(h-s.newSizeString.length),o.dim(s.newSizeString),o.dim(" \u2502 ")," ".repeat(t.ratio-s.ratioString.length),o.dim(s.ratioString),o.dim(` \u2502 Skipped \u2502 Larger than ${s.webpDeleted||s.avifDeleted}`)):w.push(s.ratio<0?o.green(l):s.ratio>0?o.yellow(l):l," ".repeat(n-i-s.newPath.length+c)," ".repeat(h-s.newSizeString.length),o.dim(s.newSizeString),o.dim(" \u2502 ")," ".repeat(t.ratio-s.ratioString.length),s.ratio<0?o.green(s.ratioString):s.ratio>0?o.red(s.ratioString):s.ratioString,o.dim(" \u2502 ")," ".repeat(t.duration-s.durationString.length),o.dim(s.durationString)),p.info(w.join(""))})}function he(e,p,t){p.info("");let r=[" \u2514\u2500 "," \u251C\u2500 "],i=r[0].length,c=2,n=Math.max(t.oldPath,t.newPath+i);e.forEach((h,s,S)=>{let k=h.oldPath.length?x.basename(h.oldPath):"",P=h.newPath.length?x.basename(h.newPath):"",l=["  "];if(s===0&&(l.push(k.length?o.dim(h.oldPath.replace(new RegExp(`${F(k)}$`),""))+k:"(empty filepath)"),p.info(l.join("")),l=["  "]),S.length===1&&P.length===0)switch(l.push(o.dim(r[0])),h.errorType){case"skip":l.push(o.black.bgWhite(" SKIPPED ")," ",h.error);break;case"warning":l.push(o.bgYellow(" WARNING ")," ",o.yellow(h.error));break;default:l.push(o.bgRed(" ERROR ")," ",o.red(h.error));break}else switch(l.push(o.dim(S.length===s+1?r[0]:r[1]),P.length?o.dim(h.newPath.replace(new RegExp(`${F(P)}$`),""))+P:"(empty filepath)"," ".repeat(n-(P.length?h.newPath.length:16)+c)),h.errorType){case"skip":l.push(o.black.bgWhite(" SKIPPED ")," ",h.error);break;case"warning":l.push(o.bgYellow(" WARNING ")," ",o.yellow(h.error));break;default:l.push(o.bgRed(" ERROR ")," ",o.red(h.error));break}p.info(l.join(""))})}function pe(e){let p=[o.yellow("\u26A1"),o.cyan("vite-plugin-imagemin")].join(""),t=ne(e);if(!t)throw new Error("Missing valid `plugins` option");let r,i,c,n,h=t.onlyAssets,s=t.verbose,S=t.formatFilePath,k=t.logByteDivider,P=k===1e3?"kB":"KiB";let l={info:()=>{},warn:()=>{},error:()=>{}},w=se(t.include,t.exclude),g={size:2,ratio:2,duration:0},y=!1;return{name:"vite-plugin-imagemin",enforce:"post",apply:"build",configResolved:M=>{r=M,i=t.root||r.root,c=O(x.resolve(i,r.build.outDir)),n=O(x.resolve(c,r.build.assetsDir)),s&&(l=t.logger||r.logger)},async closeBundle(){let M=D.now();l.info("");let U=h?n:c,A=`${i}/`,V=new RegExp(`^${F(A)}`),K=Q(U,l).filter(w).map(a=>[O(a).replace(V,""),O(S(a)).replace(V,"")]);if(K.length===0)return;let L={jpg:/\.jpe?g$/i,gif:/\.gif$/i,png:/\.png$/i,svg:/\.svg$/i},E={},W=[];K.forEach(([a,d])=>{if(E[a]=[],Object.keys(t.plugins).forEach(m=>{(L?.[m]&&L[m].test(a)||a.endsWith(`.${m}`))&&(E[a].push({toPath:d,plugins:t.plugins[m],skipIfLarger:t.skipIfLarger}),W.push(d))}),R(t.makeAvif)){let m=t.makeAvif.formatFilePath,u=t.makeAvif.skipIfLargerThan;Object.entries(t.makeAvif.plugins).forEach(([f,b])=>{(L?.[f]&&L[f].test(a)||a.endsWith(`.${f}`))&&(E[a].push({toPath:m(d),plugins:b,skipIfLarger:u}),W.push(m(d)))})}if(R(t.makeWebp)){let m=t.makeWebp.formatFilePath,u=t.makeWebp.skipIfLargerThan;Object.entries(t.makeWebp.plugins).forEach(([f,b])=>{(L?.[f]&&L[f].test(a)||a.endsWith(`.${f}`))&&(E[a].push({toPath:m(d),plugins:b,skipIfLarger:u}),W.push(m(d)))})}E[a].length===0?delete E[a]:y=!0}),H(W.map(a=>A+a));let{totalSize:j,maxLengths:G,processedFiles:v,erroredFiles:Y}=await Promise.allSettled(Object.entries(E).map(([a,d])=>oe({filePathFrom:a,fileToStack:d,baseDir:A,precisions:g,bytesDivider:k,sizeUnit:P}))).then(a=>le(a));if(y&&(l.info([p," processed these files:"].join("")),Object.keys(v).sort((a,d)=>a.localeCompare(d)).forEach(a=>{let d=v[a].findIndex(u=>u.newPath.endsWith(".webp"));if(t.makeWebp&&t.makeWebp.skipIfLargerThan&&d>=0){let u=v[a][d],f=!1;if(t.makeWebp.skipIfLargerThan==="smallest")f=v[a].slice().sort((I,B)=>I.ratio-B.ratio)[0].ratio<u.ratio;else if(t.makeWebp.skipIfLargerThan==="optimized"){let b=v[a].find(I=>I.newPath.replace(/\.webp$/,""));f=Boolean(b&&b.ratio<u.ratio)}f&&(J(A+u.newPath),v[a][d].webpDeleted=t.makeWebp.skipIfLargerThan)}let m=v[a].findIndex(u=>u.newPath.endsWith(".avif"));if(t.makeAvif&&t.makeAvif.skipIfLargerThan&&m>=0){let u=v[a][m],f=!1;if(t.makeAvif.skipIfLargerThan==="smallest")f=v[a].slice().sort((I,B)=>I.ratio-B.ratio)[0].ratio<u.ratio;else if(t.makeAvif.skipIfLargerThan==="optimized"){let b=v[a].find(I=>I.newPath.replace(/\.avif$/,""));f=Boolean(b&&b.ratio<u.ratio)}f&&(J(A+u.newPath),v[a][m].avifDeleted=t.makeAvif.skipIfLargerThan)}ge(v[a],l,G)}),Object.keys(Y).sort((a,d)=>a.localeCompare(d)).forEach(a=>{he(Y[a],l,G)}),s)){let a=`${(j.from/k).toFixed(g.size)}`,d=`${(j.to/k).toFixed(g.size)}`,m=`${(D.now()-M).toFixed(g.duration)}`,u=Math.max(a.length,d.length,m.length)+2,f=(j.to/j.from-1)*100,b=f<0?o.green(`-${Math.abs(f).toFixed(g.ratio)} %`):f>0?o.red(`+${Math.abs(f).toFixed(g.ratio)} %`):`${Math.abs(f).toFixed(g.ratio)} %`;l.info(""),l.info([o.dim("Total size:   ")," ".repeat(u-a.length),a,` ${P}`].join("")),l.info([o.dim("Minified size:")," ".repeat(u-d.length),d,` ${P}`,"  ",b].join("")),l.info([o.dim("Total time:     "),m," ms"].join(""))}}}}export{pe as default,Q as getAllFiles,he as logErrors,ge as logResults,ne as parseOptions,N as parsePlugins,oe as processFile,le as processResults};
/* istanbul ignore else -- @preserve */
/* istanbul ignore next -- @preserve */
